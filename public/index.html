<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Tartarus Protocol</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root { --terminal-green: #39ff14; --bg-black: #111; }
    body { margin: 0; padding: 20px; background: #000; color: var(--terminal-green); font-family: 'Share Tech Mono', monospace; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
    .crt-bezel { width: 100%; max-width: 1000px; border: 20px solid #444; border-radius: 20px; padding: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); background: #000; display: flex; flex-direction: column; position: relative; }
    .scanlines { position: absolute; top:0; left:0; width:100%; height:100%; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, transparent 2px); pointer-events: none; z-index: 10; }
    #log { flex: 1; overflow-y: auto; padding: 10px; font-size: 16px; line-height: 1.5; border-bottom: 2px solid var(--terminal-green); margin-bottom: 10px; }
    #log::-webkit-scrollbar { width: 8px; background: #111; }
    #log::-webkit-scrollbar-thumb { background: var(--terminal-green); }
    .input-area { display: flex; align-items: center; }
    #input { flex: 1; background: transparent; border: none; color: var(--terminal-green); font-size: 16px; font-family: inherit; outline: none; }
    .user-msg { color: #fff; margin-top: 10px; }
    .system-msg { color: #ffff00; margin-top: 10px; }
    .ai-msg { color: var(--terminal-green); margin-top: 5px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="crt-bezel">
    <div class="scanlines"></div>
    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
      <span>TARTARUS PROTOCOL v2.0</span>
      <span id="timer">[TIME] 10:00</span>
    </div>
    <div id="log">
      <div class="system-msg">[SYSTEM] 타르타로스 프로토콜 접속 승인.</div>
      <div class="system-msg">[MISSION] 승무원들과 대화하여 숨어있는 '배신자'를 색출하십시오.</div>
    </div>
    <div class="input-area">
      <span style="margin-right: 10px;">&gt;</span>
      <input id="input" type="text" autocomplete="off" placeholder="명령어를 입력하세요..." autofocus />
    </div>
  </div>

  <script>
    const log = document.getElementById('log');
    const input = document.getElementById('input');
    let history = [];

    // 타이머 작동
    let time = 600;
    setInterval(() => {
      time--;
      if(time < 0) time = 0;
      const min = Math.floor(time / 60);
      const sec = String(time % 60).padStart(2, '0');
      document.getElementById('timer').innerText = `[TIME] ${min}:${sec}`;
    }, 1000);

    // 메시지 전송 (Fetch 사용 - 소켓 완전 제거)
    input.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter' && input.value.trim() !== '') {
        const msg = input.value;
        input.value = '';
        input.disabled = true;

        // 내 메시지 표시
        addLog(`> ${msg}`, 'user-msg');
        history.push({ role: 'user', content: msg });

        try {
          // Vercel Function 호출 (/api/chat)
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg, history: history })
          });
          
          if (!res.ok) throw new Error(res.status);

          const data = await res.json();
          addLog(data.result, 'ai-msg');
          history.push({ role: 'assistant', content: data.result });
        } catch (err) {
          console.error(err);
          addLog(`[ERROR] 시스템 응답 없음. 잠시 후 다시 시도하십시오.`, 'system-msg');
        }
        
        input.disabled = false;
        input.focus();
      }
    });

    function addLog(text, className) {
      const div = document.createElement('div');
      div.className = className;
      div.innerText = text;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }
  </script>
</body>
</html>