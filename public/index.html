<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Tartarus Protocol</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap" rel="stylesheet">
    <style>
      /* --- [CRT 모니터 기본 스타일] --- */
      :root { color-scheme: dark; --terminal-green: #39ff14; --bg-black: #111; --alert-red: #ff0000; }
      * { box-sizing: border-box; }
      body { margin: 0; padding: 20px; min-height: 100vh; background: #000; color: var(--terminal-green); font-family: 'Share Tech Mono', monospace; display: flex; align-items: center; justify-content: center; overflow: hidden; }

      /* 베젤 및 화면 외관 */
      .crt-bezel { width: 95%; max-width: 1200px; background: #151515; border: 25px solid #333; border-radius: 20px; padding: 20px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.8); }
      #game-container { background: var(--bg-black); border: 2px solid #333; border-radius: 5px; padding: 20px; height: 700px; position: relative; display: flex; flex-direction: column; box-shadow: inset 0 0 100px rgba(0,0,0,0.9); overflow: hidden; }
      
      /* 스캔라인 (배경 효과만 은은하게 유지) */
      .scanlines { position: absolute; inset: 0; pointer-events: none; z-index: 10; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, transparent 1px, transparent 2px); }
      
      /* 상단 바 */
      .title-bar { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; border-bottom: 1px solid var(--terminal-green); padding-bottom: 5px; z-index: 20; }
      
      /* 로그 영역 */
      #log { flex: 1; overflow-y: auto; padding-bottom: 20px; font-size: 16px; line-height: 1.6; z-index: 20; }
      #log::-webkit-scrollbar { width: 8px; }
      #log::-webkit-scrollbar-thumb { background: var(--terminal-green); }

      /* ★ 춤추는 글자 효과 제거됨 (가독성 확보) ★ */
      .line { margin-bottom: 8px; text-shadow: 0 0 2px currentColor; }

      /* 캐릭터별 색상 */
      .role-captain { color: #ff5555; }
      .role-engineer { color: #ffaa00; }
      .role-doctor { color: #00ffff; }
      .role-pilot { color: #5588ff; }
      .role-system { color: var(--terminal-green); opacity: 0.9; }
      .role-alert { color: #ff0000; font-weight: bold; }
      .role-user { color: #ff00ff; font-weight: bold; }

      /* ★ 하단 버튼 3개 복구 ★ */
      .action-bar { display: flex; gap: 10px; margin-top: 10px; z-index: 20; }
      .action-btn { flex: 1; background: rgba(0, 20, 0, 0.5); border: 1px solid var(--terminal-green); color: var(--terminal-green); padding: 12px; font-family: inherit; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
      .action-btn:hover { background: var(--terminal-green); color: #000; font-weight: bold; }

      /* 입력창 */
      .input-row { display: flex; align-items: center; border-top: 1px solid var(--terminal-green); padding-top: 10px; margin-top: 10px; z-index: 20; }
      #input { flex: 1; background: transparent; border: none; color: var(--terminal-green); font-size: 16px; font-family: inherit; outline: none; margin-left: 10px; }

      /* 긴급 처형 버튼 (빨간색) */
      .accuse-btn-main { width: 100%; margin-top: 10px; border: 2px solid var(--alert-red); color: var(--alert-red); background: rgba(50,0,0,0.3); padding: 10px; cursor: pointer; font-family: inherit; font-size: 16px; font-weight: bold; z-index: 20; }
      .accuse-btn-main:hover { background: var(--alert-red); color: #000; }

      /* ★ 팝업창 (처형 선택 & 결과창) - 스크린샷 디자인 반영 ★ */
      .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; }
      .modal-overlay.active { display: flex; }
      
      .modal-box { border: 2px solid; padding: 30px; background: #050505; width: 80%; max-width: 450px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
      
      /* 처형 선택창 스타일 (빨간색 테두리) */
      .accuse-box { border-color: var(--alert-red); color: var(--alert-red); }
      .accuse-title { font-size: 20px; margin-bottom: 20px; font-weight: bold; }
      .target-btn { display: block; width: 100%; padding: 12px; margin-bottom: 10px; background: transparent; border: 1px solid var(--alert-red); color: var(--alert-red); cursor: pointer; font-family: inherit; transition: 0.2s; }
      .target-btn:hover { background: var(--alert-red); color: #000; }

      /* 결과창 스타일 */
      .result-title { font-size: 36px; font-weight: bold; margin-bottom: 20px; letter-spacing: 2px; }
      .result-desc { font-size: 16px; line-height: 1.6; margin-bottom: 30px; white-space: pre-wrap; }
      .restart-btn { padding: 10px 30px; background: transparent; border: 2px solid currentColor; color: currentColor; font-family: inherit; cursor: pointer; font-weight: bold; }
      .restart-btn:hover { background: currentColor; color: #000; }

    </style>
  </head>
  <body>
    <div class="crt-bezel">
      <div id="game-container">
        <div class="scanlines"></div>
        
        <div class="title-bar">
          <span>TARTARUS PROTOCOL v2.8</span>
          <span id="timer">[TIME] 10:00</span>
        </div>

        <div id="log"></div>

        <div class="action-bar">
          <button class="action-btn" onclick="sendMessage('승무원들과 면담하기')">승무원들과 면담하기</button>
          <button class="action-btn" onclick="sendMessage('CCTV 확인')">CCTV 확인</button>
          <button class="action-btn" onclick="sendMessage('엔진실로 이동')">엔진실로 이동</button>
        </div>

        <div class="input-row">
          <span>&gt;</span>
          <input id="input" type="text" autocomplete="off" placeholder="명령어 입력..." />
        </div>
        
        <button class="accuse-btn-main" onclick="openAccuseModal()">[ 긴급 처형 (ACCUSE) ]</button>

        <div id="accuse-modal" class="modal-overlay">
          <div class="modal-box accuse-box">
            <div class="accuse-title">배신자를 선택하세요</div>
            <button class="target-btn" onclick="triggerAccuse('선장')">선장</button>
            <button class="target-btn" onclick="triggerAccuse('엔지니어')">엔지니어</button>
            <button class="target-btn" onclick="triggerAccuse('의사')">의사</button>
            <button class="target-btn" onclick="triggerAccuse('파일럿')">파일럿</button>
            <button class="target-btn" style="border-color:#555; color:#555;" onclick="closeAccuseModal()">취소</button>
          </div>
        </div>

        <div id="result-modal" class="modal-overlay">
          <div class="modal-box" id="result-box">
            <div class="result-title" id="result-title"></div>
            <div class="result-desc" id="result-desc"></div>
            <button class="restart-btn" onclick="location.reload()">[ SYSTEM REBOOT ]</button>
          </div>
        </div>

      </div>
    </div>

    <script>
      const logEl = document.getElementById('log');
      const inputEl = document.getElementById('input');
      const accuseModal = document.getElementById('accuse-modal');
      const resultModal = document.getElementById('result-modal');
      const resultBox = document.getElementById('result-box');
      const resultTitle = document.getElementById('result-title');
      const resultDesc = document.getElementById('result-desc');
      let history = [];

      // 초기화 (오프닝 텍스트 복구)
      window.onload = () => {
        printLine("[SYSTEM] Tartarus Protocol booting...", "role-system");
        printLine("[SYSTEM] Core link established.", "role-system");
        printLine(" ", "line");
        printLine("[ALERT] 함장님(Commander), 비상 사태입니다.", "role-alert");
        printLine("승무원 중 누군가가 고의로 워프 엔진을 파괴했습니다.", "role-system");
        printLine(" ", "line");
        printLine("[MISSION]", "role-system");
        printLine("1. 대화를 통해 숨어있는 '범인(AI)'을 찾아내십시오.", "role-system");
        printLine(">> '현재 상황 보고해'라고 명령하여 게임을 시작하세요.", "role-system");
      };

      function printLine(text, className) {
        if(!text) return;
        let finalClass = className || "line";
        
        // 자동 색상 지정 (텍스트 내용 기반)
        if (!className) {
          if (text.startsWith("선장:")) finalClass = "role-captain";
          else if (text.startsWith("엔지니어:")) finalClass = "role-engineer";
          else if (text.startsWith("의사:")) finalClass = "role-doctor";
          else if (text.startsWith("파일럿:")) finalClass = "role-pilot";
          else if (text.startsWith("[ALERT]")) finalClass = "role-alert";
          else if (text.includes("[SYSTEM]")) finalClass = "role-system";
        }

        const div = document.createElement('div');
        div.className = "line " + finalClass;
        div.innerText = text;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
      }

      async function sendMessage(text) {
        if (!text) text = inputEl.value;
        if (!text.trim()) return;

        inputEl.value = '';
        printLine(`> ${text}`, "role-user");
        history.push({ role: "user", content: text });

        try {
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, history: history })
          });
          const data = await res.json();
          
          // 줄바꿈 기준으로 쪼개서 한 줄씩 출력 (캐릭터 대사 분리)
          const lines = data.result.split('\n');
          lines.forEach(line => {
            if (line.trim()) printLine(line);
          });
          
          history.push({ role: "assistant", content: data.result });

          // 승패 처리
          if (data.state === 'victory' || data.state === 'defeat') {
            setTimeout(() => showResult(data.state, data.result), 1500);
          }
        } catch (err) {
          printLine(`[ERROR] ${err.message}`, "role-alert");
        }
      }

      inputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

      // 모달 관련 함수
      function openAccuseModal() { accuseModal.classList.add('active'); }
      function closeAccuseModal() { accuseModal.classList.remove('active'); }
      
      function triggerAccuse(target) {
        closeAccuseModal();
        sendMessage(`[ACCUSE] ${target}`);
      }

      function showResult(state, message) {
        resultModal.classList.add('active');
        let traitorName = "알 수 없음";
        // 진짜 배신자 이름 추출
        const match = message.match(/식별 코드\s*:\s*\[(.*?)\]/);
        if (match) traitorName = match[1];

        if (state === 'victory') {
          resultBox.style.borderColor = "#39ff14";
          resultBox.style.color = "#39ff14";
          resultTitle.innerText = "VICTORY";
          resultDesc.innerText = "TARTARUS SYSTEM: [TARGET TERMINATED].\n관찰 결과: 하얀색 유체(White Fluid) 식별됨.\n안드로이드 배신자 제거 성공.";
        } else {
          resultBox.style.borderColor = "#ff0000";
          resultBox.style.color = "#ff0000";
          resultTitle.innerText = "DEFEAT";
          resultDesc.innerText = `TARTARUS SYSTEM: [TARGET TERMINATED].\n관찰 결과: 붉은 혈액(Red Blood) 식별됨.\n무고한 승무원 사망. 미션 실패.\n\n진짜 배신자 식별 코드 : [ ${traitorName} ]`;
        }
      }
    </script>
  </body>
</html>