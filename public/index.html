<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Tartarus Protocol</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap" rel="stylesheet">
    <style>
      :root { --terminal-green: #39ff14; --bg-black: #050505; --alert-red: #ff0000; }
      * { box-sizing: border-box; }
      
      body {
        margin: 0; padding: 20px; min-height: 100vh; background: #000;
        color: var(--terminal-green); font-family: 'Share Tech Mono', monospace;
        display: flex; align-items: center; justify-content: center; overflow: hidden;
      }
      
      .crt-bezel {
        width: 95%; max-width: 1200px;
        background: #151515; border: 25px solid #333; border-radius: 20px;
        padding: 20px; position: relative;
        box-shadow: 0 0 50px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.8);
      }

      #game-container {
        height: 700px; display: flex; flex-direction: column; position: relative;
        border: 2px solid #222; padding: 20px; background: var(--bg-black); overflow: hidden;
        box-shadow: inset 0 0 150px rgba(0,0,0, 0.9); /* 비네팅 유지 */
      }
      
      .scanlines {
        position: absolute; inset: 0; pointer-events: none; z-index: 10;
        background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, transparent 1px, transparent 2px);
      }
      
      .screen-glow {
        position: absolute; inset: 0; pointer-events: none; z-index: 5;
        background: radial-gradient(circle, rgba(57,255,20,0.05) 0%, rgba(0,0,0,0) 80%);
      }

      .title-bar {
        display: flex; justify-content: space-between; margin-bottom: 10px;
        font-size: 14px; color: var(--terminal-green); border-bottom: 1px solid rgba(57,255,20,0.3);
        padding-bottom: 5px; z-index: 20; position: relative;
      }
      
      #log {
        flex: 1; overflow-y: auto; padding-bottom: 20px; font-size: 16px; line-height: 1.6;
        z-index: 20; position: relative;
        text-shadow: 0 0 2px var(--terminal-green);
      }
      #log::-webkit-scrollbar { width: 8px; }
      #log::-webkit-scrollbar-thumb { background: rgba(57,255,20,0.3); }

      /* 액션 버튼 */
      .action-bar { display: flex; gap: 10px; margin-bottom: 10px; z-index: 20; position: relative; }
      .action-btn { 
        flex: 1; background: rgba(0, 20, 0, 0.5); border: 1px solid var(--terminal-green); color: var(--terminal-green); 
        padding: 12px; font-family: inherit; cursor: pointer; text-align: center; font-size: 14px; 
        transition: all 0.2s; text-transform: uppercase; box-shadow: 0 0 5px rgba(57,255,20,0.2);
      }
      .action-btn:hover { background: var(--terminal-green); color: #000; box-shadow: 0 0 15px var(--terminal-green); }

      .input-row { display: flex; align-items: center; border-top: 1px solid rgba(57,255,20,0.3); padding-top: 10px; z-index: 20; position: relative; }
      #input { 
        flex: 1; background: transparent; border: none; color: var(--terminal-green); 
        font-size: 16px; font-family: inherit; outline: none; text-shadow: 0 0 2px var(--terminal-green);
      }
      
      .accuse-btn-main { 
        width: 100%; margin-top: 10px; border: 1px solid #ff0000; color: #ff0000; 
        background: rgba(50,0,0,0.3); padding: 10px; cursor: pointer; font-family: inherit; z-index: 20; position: relative;
        text-transform: uppercase; letter-spacing: 2px;
      }
      .accuse-btn-main:hover { background: #ff0000; color: #000; box-shadow: 0 0 15px #ff0000; }

      /* ★ 신규 추가: 처형 UI 모달 (Prompt 대체) ★ */
      #accuse-modal {
        position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 100;
        display: none; justify-content: center; align-items: center; flex-direction: column;
      }
      #accuse-modal.active { display: flex; }
      
      .modal-content {
        border: 2px solid var(--alert-red); padding: 30px; background: #050000;
        width: 80%; max-width: 400px; text-align: center;
        box-shadow: 0 0 30px rgba(255,0,0,0.3);
      }
      .modal-title { 
        color: var(--alert-red); font-size: 20px; margin-bottom: 20px; 
        text-shadow: 0 0 5px var(--alert-red); font-weight: bold;
      }
      .target-btn {
        display: block; width: 100%; padding: 12px; margin-bottom: 10px;
        background: transparent; border: 1px solid var(--alert-red); color: var(--alert-red);
        cursor: pointer; font-family: inherit; font-size: 16px; text-transform: uppercase;
        transition: 0.2s;
      }
      .target-btn:hover { background: var(--alert-red); color: #000; font-weight: bold; }
      .cancel-btn { border-color: #555; color: #555; margin-top: 20px; }
      .cancel-btn:hover { background: #555; color: #fff; }

      /* 캐릭터별 색상 */
      .role-captain { color: #ff5555; text-shadow: 0 0 5px #ff0000; }
      .role-engineer { color: #ffaa00; text-shadow: 0 0 5px #ffaa00; }
      .role-doctor { color: #00ffff; text-shadow: 0 0 5px #00ffff; }
      .role-pilot { color: #5588ff; text-shadow: 0 0 5px #0055ff; }
      .role-system { color: var(--terminal-green); }
      .role-alert { color: #ff0000; font-weight: bold; animation: blink 1s infinite; }
      .role-user { color: #ff00ff; font-weight: bold; }
      
      @keyframes blink { 50% { opacity: 0; } }
    </style>
  </head>
  <body>
    <div class="crt-bezel">
      <div id="game-container">
        <div class="scanlines"></div>
        <div class="screen-glow"></div>

        <div class="title-bar">
          <span>TARTARUS PROTOCOL v2.3</span>
          <span id="timer">[TIME] 10:00</span>
        </div>

        <div id="log"></div>

        <div class="action-bar">
          <button class="action-btn" onclick="send('승무원들과 면담하기')">승무원들과 면담하기</button>
          <button class="action-btn" onclick="send('CCTV 확인')">CCTV 확인</button>
          <button class="action-btn" onclick="send('엔진실로 이동')">엔진실로 이동</button>
        </div>

        <div class="input-row">
          <span style="margin-right: 10px;">&gt;</span>
          <input id="input" type="text" autocomplete="off" placeholder="명령어 입력..." />
        </div>
        <button class="accuse-btn-main" onclick="openAccuseModal()">[ 긴급 처형 (ACCUSE) ]</button>

        <div id="accuse-modal">
          <div class="modal-content">
            <div class="modal-title">! WARNING: EXECUTION !<br>처형 대상을 선택하십시오</div>
            <button class="target-btn" onclick="confirmAccuse('선장')">선장 (Captain)</button>
            <button class="target-btn" onclick="confirmAccuse('엔지니어')">엔지니어 (Engineer)</button>
            <button class="target-btn" onclick="confirmAccuse('의사')">의사 (Doctor)</button>
            <button class="target-btn" onclick="confirmAccuse('파일럿')">파일럿 (Pilot)</button>
            <button class="target-btn cancel-btn" onclick="closeAccuseModal()">취소 (CANCEL)</button>
          </div>
        </div>

      </div>
    </div>

    <script>
      const logEl = document.getElementById('log');
      const inputEl = document.getElementById('input');
      const accuseModal = document.getElementById('accuse-modal');
      let history = [];
      
      window.onload = () => {
        printLine("[SYSTEM BOOT SEQUENCE...]", "role-system");
        printLine("접속 대상: USSC 타르타로스 (Tartarus)", "role-system");
        printLine("목표: 해왕성 궤도 워프 (Neptune Warp)", "role-system");
        printLine(" ", "role-system");
        
        printLine("[SYSTEM] 생명 유지 장치 해제... 냉동 수면 종료.", "role-system");
        printLine(" ", "role-system");

        printLine("[ALERT] 함장님(Commander), 비상 사태입니다.", "role-alert");
        printLine("현재 타르타로스 호는 궤도를 이탈했습니다.", "role-system");
        printLine("승무원 중 누군가가 고의로 워프 엔진을 파괴했습니다.", "role-system");
        printLine(" ", "role-system");

        printLine("[MISSION]", "role-system");
        printLine("1. 대화를 통해 숨어있는 '범인(AI)'을 찾아내십시오.", "role-system");
        printLine("2. 원자로를 수리하여 함선을 구하십시오.", "role-system");
        printLine(" ", "role-system");

        printLine(">> 엔지니어에게 \"현재 상황 보고해\"라고 명령하십시오.", "role-system");
      };

      function printLine(text, forcedClass) {
        if(!text) return;
        let cleanText = text.replace(/\*\*/g, ""); 
        let finalClass = forcedClass;

        if (!finalClass) {
          if (cleanText.includes("선장:")) finalClass = "role-captain";
          else if (cleanText.includes("엔지니어:")) finalClass = "role-engineer";
          else if (cleanText.includes("의사:")) finalClass = "role-doctor";
          else if (cleanText.includes("파일럿:")) finalClass = "role-pilot";
          else if (cleanText.includes("[ALERT]")) finalClass = "role-alert";
          else if (cleanText.includes("시스템:") || cleanText.includes("[SYSTEM]")) finalClass = "role-system";
          else finalClass = "role-system";
        }

        const div = document.createElement('div');
        div.className = finalClass;
        div.innerText = cleanText;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
      }

      async function send(msg) {
        if (!msg) msg = inputEl.value;
        if (!msg.trim()) return;

        inputEl.value = '';
        printLine(`> ${msg}`, "role-user");
        history.push({ role: "user", content: msg });

        try {
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg, history: history })
          });
          const data = await res.json();
          if(data.error) throw new Error(data.error);
          
          const lines = data.result.split('\n');
          let delay = 0;
          lines.forEach((line) => {
            if(line.trim() !== "") {
              setTimeout(() => {
                printLine(line);
              }, delay);
              delay += 300; 
            }
          });

          history.push({ role: "assistant", content: data.result });

        } catch (err) {
          printLine(`[ERROR] 통신 실패: ${err.message}`, "role-alert");
        }
      }

      inputEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') send();
      });

      // ★ 처형 UI 모달 제어 함수 ★
      function openAccuseModal() {
        accuseModal.classList.add('active');
      }
      function closeAccuseModal() {
        accuseModal.classList.remove('active');
      }
      function confirmAccuse(target) {
        closeAccuseModal();
        send(`[ACCUSE] ${target}`);
      }
    </script>
  </body>
</html>