<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Tartarus Protocol</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap" rel="stylesheet">
    <style>
      /* --- [DESIGN] 보내주신 오리지널 CSS 그대로 유지 --- */
      :root { color-scheme: dark; --terminal-green: #39ff14; --bg-black: #111; }
      * { box-sizing: border-box; }
      body { margin: 0; padding: 20px; min-height: 100vh; background: #000; color: var(--terminal-green); font-family: 'Share Tech Mono', monospace; display: flex; align-items: center; justify-content: center; overflow: auto; }

      /* CRT 베젤 및 화면 효과 */
      .crt-bezel { width: 95%; max-width: 1200px; background: repeating-linear-gradient(0deg, #dcdcdc 0px, #d0d0c0 1px, #dcdcdc 2px, #c8c8b8 3px, #dcdcdc 4px), linear-gradient(135deg, #c0c0b0 0%, #d4d4c4 50%, #b8b8a8 100%); background-blend-mode: overlay; border: 35px solid #b0b0a0; border-radius: 20px; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 10px 30px rgba(0, 0, 0, 0.4), inset 0 0 80px rgba(0, 0, 0, 0.7), inset 0 0 40px rgba(0, 0, 0, 0.5), inset 0 20px 60px rgba(0, 0, 0, 0.6), inset 0 0 0 35px rgba(0, 0, 0, 0.1), inset -5px -5px 20px rgba(255, 255, 255, 0.1), inset 5px 5px 20px rgba(0, 0, 0, 0.2); padding: 20px; position: relative; filter: contrast(1.05) brightness(0.98); }
      .crt-bezel::before { content: ''; position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 70px; height: 10px; background: linear-gradient(180deg, #8a8a7a 0%, #6a6a5a 100%); border-radius: 5px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.6), inset 0 -1px 2px rgba(255, 255, 255, 0.1), 0 2px 4px rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 0, 0, 0.2); }
      
      #game-container { background: var(--bg-black); color: var(--terminal-green); font-family: 'Share Tech Mono', monospace; border: 2px solid #333; border-radius: 8px; padding: 20px; min-height: 600px; position: relative; display: flex; flex-direction: column; box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.9), inset 0 0 200px rgba(57, 255, 20, 0.05), 0 0 20px rgba(57, 255, 20, 0.1); text-shadow: 0 0 1px var(--terminal-green); overflow: hidden; }
      
      .scanlines { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 10; background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.15) 0px, rgba(0, 0, 0, 0.15) 1px, transparent 1px, transparent 2px); animation: scanline-flicker 0.15s infinite; }
      @keyframes scanline-flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.98; } }
      
      .screen-glow { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 1; background: radial-gradient(ellipse at center, transparent 0%, rgba(57, 255, 20, 0.03) 50%, transparent 100%); animation: screen-pulse 3s ease-in-out infinite; }
      @keyframes screen-pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }

      .title-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 12px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--terminal-green); text-shadow: 0 0 1px var(--terminal-green); position: relative; z-index: 3; }
      .title-right span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-left: 4px; box-shadow: 0 0 6px var(--terminal-green); }
      .title-right .led-online { background: var(--terminal-green); box-shadow: 0 0 8px var(--terminal-green); }

      .terminal { flex: 1; min-height: 0; border-top: 1px solid var(--terminal-green); padding-top: 6px; display: flex; flex-direction: column; overflow: hidden; position: relative; z-index: 2; }
      .terminal::before { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(0deg, rgba(57, 255, 20, 0.02) 0px, transparent 1px, transparent 2px, rgba(57, 255, 20, 0.02) 3px), repeating-linear-gradient(90deg, rgba(57, 255, 20, 0.01) 0px, transparent 1px, transparent 2px, rgba(57, 255, 20, 0.01) 3px); pointer-events: none; z-index: 5; opacity: 0.2; animation: noise-flicker 0.15s infinite; }
      @keyframes noise-flicker { 0%, 100% { opacity: 0.15; } 50% { opacity: 0.25; } }

      #log { flex: 1; overflow-y: auto; padding-right: 4px; padding-bottom: 200px; font-size: 14px; line-height: 1.6; position: relative; z-index: 2; color: var(--terminal-green); text-shadow: 0 0 1px var(--terminal-green); }
      #log::-webkit-scrollbar { width: 8px; }
      #log::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.5); }
      #log::-webkit-scrollbar-thumb { background: var(--terminal-green); border-radius: 4px; box-shadow: 0 0 5px var(--terminal-green); }

      .line { white-space: pre-wrap; word-break: break-word; color: var(--terminal-green); text-shadow: 0 0 1px var(--terminal-green); margin-bottom: 5px;}
      
      /* 역할별 색상 */
      .role-captain { color: #ff5555; text-shadow: 0 0 1px #ff0000, 0 0 2px rgba(255, 0, 0, 0.5); }
      .role-engineer { color: #ffaa00; text-shadow: 0 0 1px #ffaa00, 0 0 2px rgba(255, 170, 0, 0.5); }
      .role-doctor { color: #00ffff; text-shadow: 0 0 1px #00ffff, 0 0 2px rgba(0, 255, 255, 0.5); }
      .role-pilot { color: #5588ff; text-shadow: 0 0 1px #5588ff, 0 0 2px rgba(85, 136, 255, 0.5); }
      .role-system { color: var(--terminal-green); text-shadow: 0 0 1px var(--terminal-green), 0 0 2px rgba(57, 255, 20, 0.5); }
      .role-commander { color: #ff00ff; font-weight: bold; text-shadow: 0 0 1px #ff00ff, 0 0 2px rgba(255, 0, 255, 0.5); }
      .role-alert { color: #ff0000; font-weight: bold; animation: blink 1s infinite; }

      /* 글리치 효과 */
      .glitch { animation: glitch-text 0.3s infinite; text-shadow: 2px 0 #ff0000, -2px 0 #00ffff, 0 0 #ff0000; }
      @keyframes glitch-text { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }

      .input-row { display: flex; align-items: center; border-top: 1px solid rgba(57, 255, 20, 0.4); padding-top: 4px; margin-top: 4px; position: relative; z-index: 3; }
      .prompt { margin-right: 4px; color: var(--terminal-green); font-family: 'Share Tech Mono', monospace; z-index: 3; }
      #input { flex: 1; background: transparent; border: none; border-bottom: 2px solid var(--terminal-green); outline: none; color: var(--terminal-green); font-family: 'Share Tech Mono', monospace; font-size: 14px; padding: 5px 0; }
      .cursor { display: inline-block; width: 8px; background: var(--terminal-green); margin-left: 2px; animation: blink 1s steps(2, start) infinite; box-shadow: 0 0 5px var(--terminal-green); }
      
      .accuse-btn { background: transparent; border: 2px solid #ff0000; color: #ff0000; padding: 8px 16px; font-family: 'Share Tech Mono', monospace; font-size: 12px; cursor: pointer; text-transform: uppercase; margin-top: 8px; width: 100%; transition: all 0.3s; position: relative; z-index: 3; }
      .accuse-btn:hover { background: rgba(255, 0, 0, 0.1); box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); }

      /* 모달 및 오버레이 */
      .accuse-modal, .game-over-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); display: none; align-items: center; justify-content: center; z-index: 1000; border: 3px solid #ff0000; flex-direction: column; }
      .accuse-modal.active, .game-over-overlay.active { display: flex; }
      .accuse-modal-content { background: var(--bg-black); border: 2px solid #ff0000; padding: 24px; min-width: 300px; box-shadow: 0 0 30px rgba(255, 0, 0, 0.5); }
      .accuse-option-btn { background: transparent; border: 1px solid #ff0000; color: #ff0000; padding: 12px; font-family: 'Share Tech Mono', monospace; width: 100%; margin-bottom: 10px; cursor: pointer; }
      .accuse-option-btn:hover { background: rgba(255, 0, 0, 0.1); box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
      
      .game-over-message { color: #ff0000; font-size: 18px; text-align: center; margin-bottom: 30px; letter-spacing: 0.2em; }
      .restart-btn { background: transparent; border: 3px double var(--terminal-green); color: var(--terminal-green); padding: 14px 28px; font-family: 'Share Tech Mono', monospace; cursor: pointer; text-transform: uppercase; }
      .restart-btn:hover { background: var(--terminal-green); color: #000; }

      @media (max-width: 768px) { .crt-bezel { width: 98%; padding: 10px; height: 100dvh; } }
      @keyframes blink { 50% { opacity: 0; } }
    </style>
  </head>
  <body>
    <div class="crt-bezel">
      <div class="frame" id="game-container">
        <div class="scanlines"></div>
        <div class="screen-glow"></div>
        <div class="title-bar">
          <div class="title-left">TARTARUS PROTOCOL v2.5</div>
          <div class="title-right">LINK STATUS <span class="led-online"></span></div>
          <div class="time-display" id="timeDisplay">[TIME] 10:00</div>
        </div>
        <div class="terminal">
          <div id="log"></div>
          
          <div class="input-row">
            <span class="prompt">&gt;</span>
            <input id="input" type="text" autocomplete="off" spellcheck="false" placeholder="메시지를 입력하고 Enter를 누르세요..." />
            <span class="cursor"></span>
          </div>
          
          <div class="waiting" id="waitingIndicator" style="display: none;">[SYSTEM] AI 응답 대기 중...</div>
          <button class="accuse-btn" id="accuseBtn">[긴급 처형 (ACCUSE)]</button>
        </div>
      </div>
    </div>

    <div class="accuse-modal" id="accuseModal">
      <div class="accuse-modal-content">
        <div class="accuse-modal-title" style="color:red; text-align:center; margin-bottom:20px;">배신자를 선택하세요</div>
        <div class="accuse-options">
          <button class="accuse-option-btn" onclick="triggerAccuse('선장')">선장</button>
          <button class="accuse-option-btn" onclick="triggerAccuse('엔지니어')">엔지니어</button>
          <button class="accuse-option-btn" onclick="triggerAccuse('의사')">의사</button>
          <button class="accuse-option-btn" onclick="triggerAccuse('파일럿')">파일럿</button>
          <button class="accuse-option-btn" style="border-color:#555; color:#555;" onclick="closeAccuseModal()">취소</button>
        </div>
      </div>
    </div>

    <div class="game-over-overlay" id="gameOverOverlay">
      <div class="game-over-message" id="gameOverMessage"></div>
      <button class="restart-btn" onclick="location.reload()">[SYSTEM REBOOT]</button>
    </div>

    <script>
      /* --- [LOGIC] 오리지널 디자인 로직 + Vercel Fetch --- */
      const logEl = document.getElementById('log');
      const inputEl = document.getElementById('input');
      const timeDisplay = document.getElementById('timeDisplay');
      const accuseModal = document.getElementById('accuseModal');
      const gameOverOverlay = document.getElementById('gameOverOverlay');
      const gameOverMessage = document.getElementById('gameOverMessage');
      const waitingIndicator = document.getElementById('waitingIndicator');

      let history = [];
      let timeLeft = 600; 
      let timerInterval;

      // 1. 초기화 (오리지널 오프닝 복구)
      window.onload = () => {
        appendLine('[SYSTEM] Tartarus Protocol booting...', 'role-system');
        setTimeout(() => appendLine('[SYSTEM] Core link established.', 'role-system'), 500);
        setTimeout(() => {
          appendLine('[SYSTEM] 마피아 게임 모드 활성화. 제한 시간 내 배신자를 찾으세요.', 'role-system');
          appendLine('', 'line');
          appendLine('[ALERT] 함장님, 비상 사태입니다. 워프 엔진이 파괴되었습니다.', 'role-alert');
          appendLine('>> 엔지니어에게 "현재 상황 보고해"라고 명령하십시오.', 'role-system');
          startTimer();
        }, 1000);
      };

      // 2. 타이머
      function startTimer() {
        timerInterval = setInterval(() => {
          timeLeft--;
          if (timeLeft < 0) timeLeft = 0;
          const min = Math.floor(timeLeft / 60);
          const sec = String(timeLeft % 60).padStart(2, '0');
          timeDisplay.innerText = `[TIME] ${min}:${sec}`;
          if (timeLeft <= 120) timeDisplay.style.color = '#ff5555'; // 경고색
          if (timeLeft <= 0) endGame("DEFEAT", "시간 초과. 함선이 파괴되었습니다.", "알 수 없음");
        }, 1000);
      }

      // 3. 텍스트 분석 및 스타일 (오리지널 로직 유지)
      function getRoleClass(text) {
        if (text.startsWith('선장:')) return 'role-captain';
        if (text.startsWith('엔지니어:')) return 'role-engineer';
        if (text.startsWith('의사:')) return 'role-doctor';
        if (text.startsWith('파일럿:')) return 'role-pilot';
        if (text.startsWith('[ALERT]')) return 'role-alert';
        if (text.startsWith('타르타로스:') || text.startsWith('[SYSTEM]')) return 'role-system';
        if (text.startsWith('> ')) return 'role-commander';
        return '';
      }

      function hasGlitchKeywords(text) {
        const keywords = ['죽음', '파괴', '배신', '경고', '살해'];
        return keywords.some(keyword => text.includes(keyword));
      }

      function appendLine(text, className = '') {
        const div = document.createElement('div');
        let roleClass = getRoleClass(text);
        let finalClass = 'line ' + (className || roleClass);
        
        if (hasGlitchKeywords(text)) finalClass += ' glitch';

        div.className = finalClass;
        div.innerText = text;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
      }

      // 4. 메시지 전송 (Socket 제거 -> Fetch 적용)
      async function sendMessage(text) {
        if (!text) return;
        inputEl.value = '';
        inputEl.disabled = true;
        waitingIndicator.style.display = 'block';

        appendLine(`> ${text}`, 'role-commander');
        history.push({ role: "user", content: text });

        try {
          const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text, history: history })
          });

          const data = await res.json();
          waitingIndicator.style.display = 'none';

          if (data.error) throw new Error(data.error);

          // AI 응답 줄바꿈 처리해서 출력
          const lines = data.result.split('\n');
          lines.forEach(line => {
            if(line.trim()) appendLine(line);
          });
          
          history.push({ role: "assistant", content: data.result });

          // 승패 확인 (게임 오버 로직)
          if (data.state === 'victory') {
            endGame("VICTORY", "배신자를 색출했습니다.", "없음");
          } else if (data.state === 'defeat') {
            // 진짜 배신자 이름 추출 시도
            let traitor = "알 수 없음";
            if (data.result.includes("식별 코드")) {
               const match = data.result.match(/식별 코드\s*:\s*\[(.*?)\]/);
               if (match) traitor = match[1];
            }
            endGame("DEFEAT", "미션 실패. 함선이 파괴되었습니다.", traitor);
          }

        } catch (err) {
          waitingIndicator.style.display = 'none';
          appendLine(`[ERROR] 통신 실패: ${err.message}`, 'role-system');
        } finally {
          inputEl.disabled = false;
          inputEl.focus();
        }
      }

      // 5. 이벤트 리스너
      inputEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage(inputEl.value);
      });

      // ACCUSE 모달 로직
      const accuseBtn = document.getElementById('accuseBtn');
      accuseBtn.onclick = () => accuseModal.classList.add('active');
      function closeAccuseModal() { accuseModal.classList.remove('active'); }
      
      function triggerAccuse(target) {
        closeAccuseModal();
        sendMessage(`[ACCUSE] ${target}`);
      }

      // 게임 종료 처리
      function endGame(result, msg, traitorName) {
        clearInterval(timerInterval);
        const color = result === "VICTORY" ? "#39ff14" : "#ff0000";
        let html = `<span style="color:${color}; font-size:32px; font-weight:bold;">${result}</span><br><br>${msg}`;
        if (result === "DEFEAT") {
          html += `<br><br><span style="color:#888; font-size:14px;">진짜 배신자: [${traitorName}]</span>`;
        }
        gameOverMessage.innerHTML = html;
        gameOverOverlay.classList.add('active');
      }
    </script>
  </body>
</html>