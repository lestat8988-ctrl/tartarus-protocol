<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tartarus Protocol v4.0 (GLOBAL)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap" rel="stylesheet">
  <style>
    /* --- [디자인] 오리지널 CRT 모니터 스타일 유지 --- */
    :root { color-scheme: dark; --terminal-green: #39ff14; --bg-black: #111; --alert-red: #ff0000; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 20px; min-height: 100vh; background: #000; color: var(--terminal-green); font-family: 'Share Tech Mono', monospace; display: flex; align-items: center; justify-content: center; overflow: hidden; }

    /* 베젤 (테두리) */
    .crt-bezel { 
      width: 95%; max-width: 1200px; 
      background: repeating-linear-gradient(0deg, #dcdcdc 0px, #d0d0c0 1px, #dcdcdc 2px, #c8c8b8 3px, #dcdcdc 4px), linear-gradient(135deg, #c0c0b0 0%, #d4d4c4 50%, #b8b8a8 100%);
      background-blend-mode: overlay; border: 35px solid #b0b0a0; border-radius: 20px; 
      padding: 20px; position: relative; 
      box-shadow: 0 25px 80px rgba(0,0,0,0.6), inset 0 0 80px rgba(0,0,0,0.7); 
    }

    /* 화면 내부 */
    #game-container { 
      background: var(--bg-black); border: 2px solid #333; border-radius: 5px; 
      padding: 20px; height: 600px; position: relative; display: flex; flex-direction: column; 
      box-shadow: inset 0 0 100px rgba(0,0,0,0.9); overflow: hidden; 
    }
    
    /* 스캔라인 (배경 효과) */
    .scanlines { position: absolute; inset: 0; pointer-events: none; z-index: 10; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, transparent 1px, transparent 2px); }
    
    /* 상단 정보 */
    .title-bar { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; border-bottom: 1px solid var(--terminal-green); padding-bottom: 5px; z-index: 20; }
    
    /* 로그 영역 */
    #log { flex: 1; overflow-y: auto; padding-bottom: 20px; font-size: 16px; line-height: 1.6; z-index: 20; text-shadow: 0 0 2px var(--terminal-green); }
    #log::-webkit-scrollbar { width: 8px; }
    #log::-webkit-scrollbar-thumb { background: var(--terminal-green); }

    .line { margin-bottom: 5px; } /* 글자 춤추는 효과 제거됨 */

    /* 캐릭터별 색상 (형광 효과) - 고정된 역할만 존재 */
    .role-alert { color: #ff0000; font-weight: bold; text-shadow: 0 0 3px #ff0000; }
    .role-navigator { color: #ffd700; text-shadow: 0 0 3px #ffd700; }
    .role-engineer { color: #ff8c00; text-shadow: 0 0 3px #ff8c00; }
    .role-doctor { color: #00bfff; text-shadow: 0 0 3px #00bfff; }
    .role-pilot { color: #da70d6; text-shadow: 0 0 3px #da70d6; }
    .role-system { color: #39ff14; text-shadow: 0 0 2px #39ff14; }
    .role-user { color: #ffffff; font-weight: bold; text-shadow: 0 0 3px #ffffff; }

    /* ★ 하단 버튼 3개 (스타일 복구) ★ */
    .action-bar { display: flex; gap: 10px; margin-top: 10px; z-index: 20; }
    .action-btn { 
      flex: 1; background: rgba(0, 20, 0, 0.5); border: 1px solid var(--terminal-green); 
      color: var(--terminal-green); padding: 12px; font-family: inherit; cursor: pointer; 
      text-transform: uppercase; transition: 0.2s; font-weight: bold;
    }
    .action-btn:hover { background: var(--terminal-green); color: #000; }

    /* 입력창 */
    .input-row { display: flex; align-items: center; border-top: 1px solid var(--terminal-green); padding-top: 10px; margin-top: 10px; z-index: 20; }
    #input { flex: 1; background: transparent; border: none; color: var(--terminal-green); font-size: 16px; font-family: inherit; outline: none; margin-left: 10px; }

    /* 긴급 처형 버튼 */
    .accuse-btn-main { 
      width: 100%; margin-top: 10px; border: 2px solid var(--alert-red); color: var(--alert-red); 
      background: rgba(50,0,0,0.3); padding: 10px; cursor: pointer; font-family: inherit; 
      font-size: 16px; font-weight: bold; z-index: 20; 
    }
    .accuse-btn-main:hover { background: var(--alert-red); color: #000; }

    /* 팝업창 (처형 선택 & 결과) */
    .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .modal-overlay.active { display: flex; }
    .modal-box { border: 2px solid; padding: 30px; background: #050505; width: 80%; max-width: 450px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    
    .accuse-box { border-color: var(--alert-red); color: var(--alert-red); }
    .target-btn { display: block; width: 100%; padding: 12px; margin-bottom: 10px; background: transparent; border: 1px solid var(--alert-red); color: var(--alert-red); cursor: pointer; font-family: inherit; }
    .target-btn:hover { background: var(--alert-red); color: #000; }

    .result-title { font-size: 32px; font-weight: bold; margin-bottom: 20px; }
    .restart-btn { padding: 10px 30px; background: transparent; border: 2px solid currentColor; color: currentColor; font-family: inherit; cursor: pointer; font-weight: bold; }
    .restart-btn:hover { background: currentColor; color: #000; }

    /* 모바일 반응형 디자인 */
    @media (max-width: 768px) {
      body { padding: 5px; }
      
      /* 1. CRT 베젤 테두리와 패딩 대폭 축소 */
      .crt-bezel {
        width: 100%;
        border: 8px solid #b0b0a0;
        padding: 8px;
        border-radius: 10px;
      }
      
      /* 4. 게임 컨테이너 높이를 유동적으로 변경 */
      #game-container {
        height: 80vh;
        padding: 12px;
        min-height: 500px;
      }
      
      /* 3. 폰트 크기 축소 */
      .title-bar {
        font-size: 12px;
        margin-bottom: 8px;
        padding-bottom: 4px;
      }
      
      #log {
        font-size: 13px;
        line-height: 1.5;
        padding-bottom: 12px;
      }
      
      .line {
        font-size: 13px;
        margin-bottom: 4px;
      }
      
      /* 2. 액션 바를 세로로 쌓기 */
      .action-bar {
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }
      
      .action-btn {
        font-size: 13px;
        padding: 10px;
        width: 100%;
      }
      
      .input-row {
        padding-top: 8px;
        margin-top: 8px;
      }
      
      #input {
        font-size: 13px;
        margin-left: 6px;
      }
      
      .accuse-btn-main {
        font-size: 13px;
        padding: 10px;
        margin-top: 8px;
      }
      
      /* 모달도 모바일에 맞게 조정 */
      .modal-box {
        padding: 20px;
        width: 90%;
        max-width: none;
      }
      
      .target-btn {
        font-size: 13px;
        padding: 10px;
        margin-bottom: 8px;
      }
      
      .result-title {
        font-size: 24px;
        margin-bottom: 15px;
      }
      
      .restart-btn {
        font-size: 13px;
        padding: 10px 20px;
      }
    }
  </style>
</head>
<body>

  <div class="crt-bezel">
    <div id="game-container">
      <div class="scanlines"></div>
      
      <div class="title-bar">
        <span>TARTARUS PROTOCOL v4.0 (GLOBAL)</span>
        <span id="timer">[TIME] 10:00</span>
      </div>

      <div id="log"></div>

      <div class="action-bar">
        <button class="action-btn" onclick="sendMessage('Interrogate crew')">INTERROGATE CREW</button>
        <button class="action-btn" onclick="sendMessage('Check CCTV logs')">CHECK CCTV LOGS</button>
        <button class="action-btn" onclick="sendMessage('Check engine room')">CHECK ENGINE ROOM</button>
      </div>

      <div class="input-row">
        <span>&gt;</span>
        <input id="input" type="text" autocomplete="off" placeholder="Enter command..." />
      </div>
      
      <button class="accuse-btn-main" onclick="openAccuseModal()">[ INITIATE PURGE PROTOCOL (ACCUSE) ]</button>

      <div id="accuse-modal" class="modal-overlay">
        <div class="modal-box accuse-box">
          <div style="font-size: 20px; margin-bottom: 20px;">SELECT TARGET FOR ELIMINATION</div>
          <button class="target-btn" onclick="triggerAccuse('Navigator')">Navigator</button>
          <button class="target-btn" onclick="triggerAccuse('Engineer')">Engineer</button>
          <button class="target-btn" onclick="triggerAccuse('Doctor')">Doctor</button>
          <button class="target-btn" onclick="triggerAccuse('Pilot')">Pilot</button>
          <button class="target-btn" style="border-color:#555; color:#555;" onclick="closeAccuseModal()">CANCEL</button>
        </div>
      </div>

      <div id="result-modal" class="modal-overlay">
        <div class="modal-box" id="result-box">
          <div class="result-title" id="result-title"></div>
          <div id="result-desc" style="margin-bottom: 20px; white-space: pre-wrap;"></div>
          <button class="restart-btn" onclick="location.reload()">[ SYSTEM REBOOT ]</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const inputEl = document.getElementById('input');
    const accuseModal = document.getElementById('accuse-modal');
    const resultModal = document.getElementById('result-modal');
    const resultBox = document.getElementById('result-box');
    
    let history = [];

    // ★ 1. Opening Script (window.onload) ★
    window.onload = () => {
      printLine("[SYSTEM BOOT SEQUENCE...]", "role-system");
      printLine("Target: USSC Tartarus", "role-system");
      printLine("Objective: Neptune Warp Mission", "role-system");
      printLine(" ", "line");
      printLine("[SYSTEM] Cryo-sleep deactivated. Life support online.", "role-system");
      printLine(" ", "line");
      
      setTimeout(() => {
        printLine("[ALERT] COMMANDER, CRITICAL EMERGENCY.", "role-alert");
        printLine("We have deviated from the trajectory.", "role-system");
        printLine("Warp Engine Sabotaged.", "role-system");
        printLine(" ", "line");
        printLine("[MISSION]", "role-system");
        printLine("1. Find the 'IMPOSTER' hidden among the crew.", "role-system");
        printLine("2. Repair the reactor to save the ship.", "role-system");
        printLine(" ", "line");
        printLine(">> Command Engineer: \"Report current status.\"", "role-system");
      }, 800);
    };

    // ★ 2. 텍스트 출력 함수 (색상 자동 적용) ★
    function printLine(text, className) {
      if(!text) return;
      let finalClass = className || "line";
      
      // Auto color mapping - Fixed roles only
      if (!className) {
        if (text.startsWith("Navigator:")) finalClass = "role-navigator";
        else if (text.startsWith("Engineer:")) finalClass = "role-engineer";
        else if (text.startsWith("Doctor:")) finalClass = "role-doctor";
        else if (text.startsWith("Pilot:")) finalClass = "role-pilot";
        else if (text.startsWith("[ALERT]")) finalClass = "role-alert";
        else if (text.includes("[SYSTEM]")) finalClass = "role-system";
        else if (text.startsWith(">")) finalClass = "role-user";
      }

      const div = document.createElement('div');
      div.className = "line " + finalClass;
      div.innerText = text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    // ★ 3. 메시지 전송 (Vercel API 통신) ★
    async function sendMessage(text) {
      if (!text) text = inputEl.value;
      if (!text.trim()) return;

      inputEl.value = '';
      printLine(`> ${text}`, "role-user");
      history.push({ role: "user", content: text });

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, history: history })
        });
        const data = await res.json();
        
        // 줄바꿈이 있으면 나눠서 출력
        const lines = data.result.split('\n');
        lines.forEach(line => {
          if (line.trim()) printLine(line);
        });
        
        history.push({ role: "assistant", content: data.result });

        // 승패 감지
        if (data.state === 'victory' || data.state === 'defeat') {
          setTimeout(() => showResult(data.state, data.result), 2000);
        }

      } catch (err) {
        printLine(`[ERROR] ${err.message}`, "role-alert");
      }
    }

    inputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

    // 모달 제어
    function openAccuseModal() { accuseModal.classList.add('active'); }
    function closeAccuseModal() { accuseModal.classList.remove('active'); }
    
    function triggerAccuse(target) {
      closeAccuseModal();
      sendMessage(`[ACCUSE] ${target}`);
    }

    function showResult(state, message) {
      resultModal.classList.add('active');
      const title = document.getElementById('result-title');
      const desc = document.getElementById('result-desc');
      
      let traitorName = "Unknown";
      const match = message.match(/Identity Code\s*:\s*\[(.*?)\]/i);
      if(match) traitorName = match[1];

      if (state === 'victory') {
        resultBox.style.borderColor = "#39ff14";
        resultBox.style.color = "#39ff14";
        title.innerText = "VICTORY";
        desc.innerText = "Congratulations. You identified the imposter and saved the ship.";
      } else {
        resultBox.style.borderColor = "#ff0000";
        resultBox.style.color = "#ff0000";
        title.innerText = "DEFEAT";
        desc.innerText = `Mission failed. The ship has been destroyed.\n\nReal Imposter: [ ${traitorName} ]`;
      }
    }
  </script>
</body>
</html>